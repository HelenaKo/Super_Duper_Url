###############################Dockerfile###############################
 
#иногда пишут версию ubuntu
FROM python:3.6.9-alpine

#новый пользователь
RUN adduser -D main

#куда будет установлено изображение
WORKDIR /Домашняя папка/Рабочий стол/Super Duper Url

#передает файлы с компьютера в файловую систему контейнера
COPY requirements.txt requirements.txt

#RUN эквиволентна командной строке
RUN python3 -m venv venv
RUN pip install -r requirements.txt
#gunicorn будет испольоваться как веб-сервер
RUN venv/bin/pip install gunicorn pymysql

#устанавливают приложение в контейнер путем копирования пакета приложения
COPY migrations migrations
COPY static static
COPY templates templates
COPY db.sqlite3 db.sqlite3
#COPY config.py config.py
# boot.sh - обязательный файл для windows, не для ubuntu
#COPY main.py config.py boot.sh ./
COPY main.py config.py 
#RUN chmod +x - так не работает
#RUN chmod +x boot.sh

#переменная среды контейнера
ENV FLASK_APP main.py

RUN chown -R main:main ./
USER main

EXPOSE 500

#ENTRYPOINT ["./boot.sh"]




###############################docker-compose.yml##############################

#3 - последняя версия            
version: '3'
    #контейнеры
     services:
        #web - мое приложение без бд
        web:
            build: .
            #ссылка на бд
            links:
                - "db:postgres"
            #сопоставить внешний порт : с внутренним портом ?
            ports:
                - "8000:80"
            #команда по умолчанию
            command: python manage.py runserver 0.0.0.0:80
            #в каталоге файл .env содержит единственную строчку FLASK APP=main.py
            env_file: .env
        #бд    
        db:
            database: db.sqlite3
            image:postgres: latest
            container_name: postgresdb
            ports:
                - 5432:5432
            port: 127.0.0.1

###############################docker-compose.yml##############################
 
#!/bin/sh
source venv/bin/activate
flask db upgrade
flask translate compile
exec gunicorn -b :5000 --access-logfile - --error-logfile - main:app
